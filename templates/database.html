{% extends "base.html" %}

{% block title %}Database Viewer{% endblock %}

{% block content %}
<div class="dashboard-header mb-24">
    <div class="flex justify-between items-center">
        <div>
            <h1>Database Viewer</h1>
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="database-controls">
    <button id="refresh-tables" class="btn btn-primary">Refresh Tables</button>
</div>

<div id="database-content">
    <div id="tables-list" class="tables-list"></div>
    <div id="table-data" class="table-data"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-tables');
    const tablesList = document.getElementById('tables-list');
    const tableData = document.getElementById('table-data');

    // Load tables on page load
    loadTables();

    // Refresh button click
    refreshButton.addEventListener('click', loadTables);

    function loadTables() {
        fetch('/api/database/tables')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTables(data.tables);
                } else {
                    alert('Error loading tables: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading tables');
            });
    }

    function displayTables(tables) {
        tablesList.innerHTML = '<h2>Tables</h2>';
        const ul = document.createElement('ul');

        tables.forEach(table => {
            const li = document.createElement('li');
            li.textContent = table;
            li.style.cursor = 'pointer';
            li.addEventListener('click', () => loadTableData(table));
            ul.appendChild(li);
        });

        tablesList.appendChild(ul);
    }

    function loadTableData(tableName) {
        fetch(`/api/database/table/${tableName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTableData(tableName, data.rows);
                } else {
                    alert('Error loading table data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading table data');
            });
    }

    function displayTableData(tableName, rows) {
        tableData.innerHTML = `<h2>Table: ${tableName}</h2>`;

        if (rows.length === 0) {
            tableData.innerHTML += '<p>No data found</p>';
            return;
        }

        // Create table element
        const table = document.createElement('table');
        table.className = 'data-table';

        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        // Add delete column header
        const deleteHeader = document.createElement('th');
        deleteHeader.textContent = 'Delete';
        headerRow.appendChild(deleteHeader);

        // Add column headers from first row
        Object.keys(rows[0]).forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create body
        const tbody = document.createElement('tbody');

        rows.forEach(row => {
            const tr = document.createElement('tr');

            // Add delete button
            const deleteCell = document.createElement('td');
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'btn btn-danger btn-small';
            deleteButton.addEventListener('click', () => deleteRow(tableName, row));
            deleteCell.appendChild(deleteButton);
            tr.appendChild(deleteCell);

            // Add row data
            Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableData.appendChild(table);
    }

    function deleteRow(tableName, row) {
        if (!confirm(`Are you sure you want to delete this row from ${tableName}?`)) {
            return;
        }

        // Find primary key (assuming first column is primary key)
        const primaryKey = Object.keys(row)[0];
        const primaryValue = row[primaryKey];

        fetch(`/api/database/table/${tableName}/row/${primaryValue}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Row deleted successfully');
                loadTableData(tableName); // Refresh table data
            } else {
                alert('Error deleting row: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting row');
        });
    }
});
</script>
{% endblock %}