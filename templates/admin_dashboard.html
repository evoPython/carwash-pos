{% extends "base.html" %}

{% block title %}Admin Dashboard - Carwash POS{% endblock %}

{% block content %}
<div class="dashboard-header mb-24">
    <h1>Admin Dashboard</h1>
    <p>Manage your carwash operations</p>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card" onclick="location.href='/summary'">
        <div class="dashboard-card-icon">üìä</div>
        <h3>Summary Reports</h3>
        <p>View daily and monthly summaries, analyze performance metrics</p>
    </div>

    <div class="dashboard-card" onclick="location.href='/users'">
        <div class="dashboard-card-icon">üë•</div>
        <h3>User Management</h3>
        <p>Add, edit, and manage user accounts and permissions</p>
    </div>

    <div class="dashboard-card" onclick="location.href='/vehicles'">
        <div class="dashboard-card-icon">üöó</div>
        <h3>Vehicle Types</h3>
        <p>Manage vehicle types, services, and pricing</p>
    </div>

    {% if user.role == 'developer' %}
    <div class="dashboard-card" onclick="location.href='/database'">
        <div class="dashboard-card-icon">üóÑÔ∏è</div>
        <h3>Database</h3>
        <p>Direct database access and management tools</p>
    </div>
    {% endif %}
</div>

<div class="grid grid-cols-1 mt-32">
    <div class="card">
        <div class="card-header">
            <h2>Recent Activity</h2>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="table" id="recentOrdersTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Washer</th>
                            <th>Plate Number</th>
                            <th>Vehicle</th>
                            <th>Service</th>
                            <th>6B Shares</th>
                            <th>Washer Shares</th>
                            <th>SSS</th>
                            <th>VAC</th>
                            <th>Less 40</th>
                            <th>Shift</th>
                            <th>Washer Name</th>
                            <th>Incharge Name</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Addon prices mapping
    const addonPrices = {
        'wax': 50,
        'polish': 100,
        'interior_cleaning': 150,
        'engine_wash': 200
    };

    // Load recent orders
    async function loadRecentOrders() {
        try {
            const response = await fetch('/api/orders');
            const orders = await response.json();

            // Log for debugging
            console.log('Admin dashboard - all orders:', orders);

            const tbody = document.querySelector('#recentOrdersTable tbody');
            tbody.innerHTML = '';

            // Sort orders by timestamp (newest first)
            const sortedOrders = orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedOrders.slice(0, 10).forEach(order => {
                const row = document.createElement('tr');
                const total = Number(order.base_price) + order.addons.reduce((sum, addon) => sum + (addonPrices[addon] || 0), 0);

                row.innerHTML = `
                    <td>${new Date(order.timestamp).toLocaleTimeString()}</td>
                    <td>${order.incharge_name}</td>
                    <td>${order.plate_number}</td>
                    <td>${order.vehicle_type}</td>
                    <td>${order.base_service}</td>
                    <td>‚Ç±${Number(order.sixb_shares).toFixed(2)}</td>
                    <td>‚Ç±${Number(order.washer_shares).toFixed(2)}</td>
                    <td>‚Ç±${Number(order.sss).toFixed(2)}</td>
                    <td>‚Ç±${Number(order.vac).toFixed(2)}</td>
                    <td>‚Ç±${Number(order.less_40).toFixed(2)}</td>
                    <td>‚Ç±${total.toFixed(2)}</td>
                    <td><span class="shift-indicator">${order.shift}</span></td>
                    <td>${order.washer_name || ''}</td>
                    <td>${order.incharge_name || ''}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading recent orders:', error);
        }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadRecentOrders);
</script>
{% endblock %}