{% extends "base.html" %}

{% block title %}Customer Management - Carwash POS{% endblock %}

{% block content %}
<div class="dashboard-header mb-24">
    <div class="flex justify-between items-center">
        <div>
            <h1>Customer Management</h1>
            <p>Assign plate numbers to customers and manage customer data</p>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Customer List</h2>
        <button class="btn btn-primary" onclick="openCustomerModal()">Add Customer</button>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="customersTable">
                <thead>
                    <tr>
                        <th>Plate Number</th>
                        <th>Customer Name</th>
                        <th>Contact No.</th>
                        <th>Vehicle Name</th>
                        <th>Washes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mt-24">
    <div class="card-header">
        <h2>Unassigned Plate Numbers</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="unassignedPlatesTable">
                <thead>
                    <tr>
                        <th>Plate Number</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Customer Modal -->
<div class="modal" id="customerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Customer</h2>
            <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="form-group">
                    <label for="plateNumber" class="form-label">Plate Number</label>
                    <input type="text" id="plateNumber" name="plateNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="customerName" class="form-label">Customer Name</label>
                    <input type="text" id="customerName" name="customerName" class="form-input">
                </div>
                <div class="form-group">
                    <label for="contactNo" class="form-label">Contact No.</label>
                    <input type="text" id="contactNo" name="contactNo" class="form-input">
                </div>
                <div class="form-group">
                    <label for="vehicleName" class="form-label">Vehicle Name</label>
                    <input type="text" id="vehicleName" name="vehicleName" class="form-input">
                </div>
                <div class="form-group">
                    <label for="washes" class="form-label">No. of times car was washed</label>
                    <input type="number" id="washes" name="washes" class="form-input" value="0" readonly>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" form="customerForm">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load customers
    async function loadCustomers() {
        try {
            const response = await fetch('/api/customers');
            const customers = await response.json();

            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';

            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.plate_number}</td>
                    <td>${customer.customer_name || ''}</td>
                    <td>${customer.contact_no || ''}</td>
                    <td>${customer.vehicle_name || ''}</td>
                    <td>${customer.washes || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCustomer('${customer._id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer._id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading customers:', error);
        }
    }

    // Load unassigned plates
    async function loadUnassignedPlates() {
        try {
            const response = await fetch('/api/unassigned_plates');
            const unassignedPlates = await response.json();

            const tbody = document.querySelector('#unassignedPlatesTable tbody');
            tbody.innerHTML = '';

            unassignedPlates.forEach(plate => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${plate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="assignPlate('${plate}')">Assign</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading unassigned plates:', error);
        }
    }

    // Open modal for adding/editing customer
    function openCustomerModal(customer = null) {
        const modal = document.getElementById('customerModal');
        const form = document.getElementById('customerForm');
        const modalTitle = document.getElementById('modalTitle');

        if (customer) {
            modalTitle.textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer._id;
            document.getElementById('plateNumber').value = customer.plate_number;
            document.getElementById('customerName').value = customer.customer_name || '';
            document.getElementById('contactNo').value = customer.contact_no || '';
            document.getElementById('vehicleName').value = customer.vehicle_name || '';
            document.getElementById('washes').value = customer.washes || 0;
        } else {
            modalTitle.textContent = 'Add Customer';
            form.reset();
            document.getElementById('customerId').value = '';
        }

        modal.classList.add('show');
    }

    // Close modal
    function closeCustomerModal() {
        document.getElementById('customerModal').classList.remove('show');
    }

    // Handle form submission
    document.getElementById('customerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const customerId = document.getElementById('customerId').value;
        const customerData = {
            plate_number: document.getElementById('plateNumber').value,
            customer_name: document.getElementById('customerName').value,
            contact_no: document.getElementById('contactNo').value,
            vehicle_name: document.getElementById('vehicleName').value,
            washes: parseInt(document.getElementById('washes').value) || 0
        };

        try {
            let response;
            if (customerId) {
                // Update existing customer
                response = await fetch(`/api/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                });
            } else {
                // Add new customer
                response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                });
            }

            const result = await response.json();
            if (result.success) {
                closeCustomerModal();
                loadCustomers();
                loadUnassignedPlates();
            } else {
                alert(result.message || 'Error saving customer');
            }
        } catch (error) {
            console.error('Error saving customer:', error);
            alert('Error saving customer');
        }
    });

    // Edit customer
    async function editCustomer(customerId) {
        try {
            const response = await fetch(`/api/customers/${customerId}`);
            const customer = await response.json();
            openCustomerModal(customer);
        } catch (error) {
            console.error('Error fetching customer:', error);
        }
    }

    // Delete customer
    async function deleteCustomer(customerId) {
        if (confirm('Are you sure you want to delete this customer?')) {
            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    loadCustomers();
                    loadUnassignedPlates();
                } else {
                    alert(result.message || 'Error deleting customer');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Error deleting customer');
            }
        }
    }

    // Assign plate number
    function assignPlate(plateNumber) {
        // Open the modal with the plate number pre-filled
        const modal = document.getElementById('customerModal');
        const form = document.getElementById('customerForm');
        const modalTitle = document.getElementById('modalTitle');

        modalTitle.textContent = 'Add Customer';
        form.reset();
        document.getElementById('customerId').value = '';
        document.getElementById('plateNumber').value = plateNumber;

        modal.style.display = 'block';
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomers();
        loadUnassignedPlates();
    });
</script>
{% endblock %}