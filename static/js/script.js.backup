document.addEventListener("DOMContentLoaded", () => {
    // Elements
    const tableEl = document.getElementById("orders-table");
    const monthInput = document.getElementById("filter-month");
    const btnRefresh = document.getElementById("btn-refresh");
    const btnOpen = document.getElementById("btn-open-modal");
    const btnTemporary = document.getElementById("btn-temporary");
    const modal = document.getElementById("modal");
    const modalClose = document.getElementById("modal-close");
    const temporaryModal = document.getElementById("temporary-modal");
    const temporaryModalClose = document.getElementById("temporary-modal-close");
    const temporaryForm = document.getElementById("temporary-form");
    const form = document.getElementById("order-form");

    // New form elements
    const vehicleTypeSelect = document.getElementById("vehicle-type");
    const serviceTypeSelect = null; // Removed service type field
    const plateNoInput = document.getElementById("plate-no");
    const wVacCheckbox = document.getElementById("w-vac");
    const priceInput = document.getElementById("price");
    const less40Input = document.getElementById("less-40");
    const cSharesInput = document.getElementById("c-shares");
    const wShareInput = document.getElementById("w-share");
    const wNameInput = document.getElementById("w-name");
    const sssInput = document.getElementById("sss");

    // Addon checkboxes
    const addonCheckboxes = document.querySelectorAll('.addon-checkboxes input[type="checkbox"]');

    // Vehicle types data
    let vehicleTypes = {};

    // Initialize table variable
    let table;

    // Initialize table and load data
    if (tableEl) {
        initTable();
        loadData();
    }

    // Load vehicle types and initialize form
    loadVehicleTypes();

    // Initialize Tabulator
    function initTable() {
        const cols = [
            {
                title: "No.", field: "id", width: 60, formatter: function (cell) {
                    // Get the row index (1-based) from the row component
                    const rowIndex = cell.getRow().getPosition();
                    return rowIndex;
                }
            },
            { title: "Vehicle Name", field: "vehicle_name", width: 150 },
            { title: "Plate No.", field: "plate_no", width: 120 },
            { title: "W/Vac", field: "w_vac", width: 80 },
            { title: "Addons", field: "addons", width: 150 },
            { title: "Price", field: "price", formatter: "money", formatterParams: { symbol: "₱" }, width: 100 },
            { title: "Less 40", field: "less_40", formatter: "money", formatterParams: { symbol: "₱" }, width: 100 },
            { title: "C-Shares", field: "c_shares", formatter: "money", formatterParams: { symbol: "₱" }, width: 100 },
            { title: "W-Share", field: "w_share", formatter: "money", formatterParams: { symbol: "₱" }, width: 100 },
            { title: "W-Name", field: "w_name", width: 150 },
            { title: "SSS", field: "sss", formatter: "money", formatterParams: { symbol: "₱" }, width: 80 },
            { title: "Timestamp", field: "timestamp", width: 150 }
        ];
        table = new Tabulator(tableEl, { layout: "fitDataStretch", columns: cols });
    }

    // Load vehicle types from JSON
    async function loadVehicleTypes() {
        try {
            const response = await fetch('/static/dict/vehicle_types.json');
            vehicleTypes = await response.json();

            // Populate vehicle type dropdown
            if (vehicleTypeSelect) {
                Object.keys(vehicleTypes).forEach(vehicleType => {
                    const option = document.createElement('option');
                    option.value = vehicleType;
                    option.textContent = vehicleType;
                    vehicleTypeSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load vehicle types:', error);
        }
    }

    // Update addon services based on selected vehicle type
    function updateAddonServices() {
        const selectedVehicle = vehicleTypeSelect.value;
        const addonsContainer = document.querySelector('.addon-checkboxes');

        // Clear existing addon checkboxes
        addonsContainer.innerHTML = '';

        if (selectedVehicle && vehicleTypes[selectedVehicle]) {
            const services = vehicleTypes[selectedVehicle];

            // Create checkboxes for each addon service
            for (const [serviceName, servicePrice] of Object.entries(services)) {
                // Skip base services (Bodywash, Bodywash with Vacuum, Vacuum Only, Spray Only)
                if (['Bodywash', 'Bodywash with Vacuum', 'Vacuum Only', 'Spray Only'].includes(serviceName)) {
                    continue;
                }

                const label = document.createElement('label');
                label.className = 'checkbox-label';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = serviceName;
                checkbox.id = `addon-${serviceName.toLowerCase().replace(' ', '-')}`;

                // Add event listener for price update
                checkbox.addEventListener('change', updatePrice);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${serviceName} (+₱${servicePrice})`));

                addonsContainer.appendChild(label);
            }
        }

        // Update the addonCheckboxes NodeList after modifying the DOM
        globalThis.addonCheckboxes = document.querySelectorAll('.addon-checkboxes input[type="checkbox"]');
    }

    // Update price based on selected vehicle, base service, and addons
    function updatePrice() {
        if (!vehicleTypeSelect || !priceInput) return;

        const selectedVehicle = vehicleTypeSelect.value;
        let basePrice = 0;

        // Get the selected base service from radio buttons
        const selectedBaseService = document.querySelector('input[name="base-service"]:checked');
        if (selectedBaseService) {
            const baseServiceName = selectedBaseService.value;
            if (selectedVehicle && vehicleTypes[selectedVehicle] && vehicleTypes[selectedVehicle][baseServiceName] !== undefined) {
                basePrice = vehicleTypes[selectedVehicle][baseServiceName];
            }
        }

        // Add addon prices
        let addonPrice = 0;
        const addonCheckboxes = document.querySelectorAll('.addon-checkboxes input[type="checkbox"]');
        addonCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                // Get the addon price from vehicleTypes data
                const addonName = checkbox.value;
                if (selectedVehicle && vehicleTypes[selectedVehicle] && vehicleTypes[selectedVehicle][addonName] !== undefined) {
                    addonPrice += vehicleTypes[selectedVehicle][addonName];
                } else {
                    // Fallback to extracting from label if not found in vehicleTypes
                    const label = checkbox.parentElement.textContent;
                    const priceMatch = label.match(/\+₱(\d+)/);
                    if (priceMatch) {
                        addonPrice += parseInt(priceMatch[1]);
                    }
                }
            }
        });

        const totalPrice = basePrice + addonPrice;
        priceInput.value = totalPrice;

        // Recalculate shares
        calculateShares();
    }

    // Define price share percentages for each add-on
    const addonShares = {
        'Bodywash': { cetadcco: 0.7, washer: 0.3 },
        'Bodywash with Vacuum': { cetadcco: 0.7, washer: 0.3 },
        'Wax': { cetadcco: 0.4, washer: 0.6 },
        'Buffing': { cetadcco: 0.5, washer: 0.5 },
        'Deep Cleaning': { cetadcco: 0.5, washer: 0.5 },
        'Engine Wash': { cetadcco: 0.5, washer: 0.5 },
        'Seat Cover': { cetadcco: 0.4, washer: 0.6 },
        'Vacuum Only': { cetadcco: 0.7, washer: 0.3 },
        'Spray Only': { cetadcco: 0.7, washer: 0.3 }
    };

    // Calculate shares based on price, VAC selection, and selected services
    function calculateShares() {
        const price = parseFloat(priceInput.value) || 0;
        const wVac = wVacCheckbox ? wVacCheckbox.checked : false;
        const vacDeduction = wVac ? 5 : 0;

        // LESS 40 is always 40
        const less40 = 40;

        // Initialize shares
        let cetadccoShare = 0;
        let washerShare = 0;

        // Get selected base service
        const selectedBaseService = document.querySelector('input[name="base-service"]:checked');
        if (selectedBaseService) {
            const baseServiceName = selectedBaseService.value;
            const selectedVehicle = vehicleTypeSelect.value;

            if (selectedVehicle && vehicleTypes[selectedVehicle] && vehicleTypes[selectedVehicle][baseServiceName] !== undefined) {
                const basePrice = vehicleTypes[selectedVehicle][baseServiceName];

                // Apply share percentages for base service (after subtracting 40)
                if (addonShares[baseServiceName]) {
                    cetadccoShare += (basePrice - less40) * addonShares[baseServiceName].cetadcco;
                    washerShare += (basePrice - less40) * addonShares[baseServiceName].washer;
                }
            }
        }

        // Get selected addons
        const selectedAddons = [];
        const addonCheckboxes = document.querySelectorAll('.addon-checkboxes input[type="checkbox"]');
        addonCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedAddons.push(checkbox.value);
            }
        });

        // Calculate shares for addons (full price, no less 40 deduction)
        selectedAddons.forEach(addon => {
            if (addonShares[addon]) {
                const addonPrice = getAddonPrice(addon);
                cetadccoShare += addonPrice * addonShares[addon].cetadcco;
                washerShare += addonPrice * addonShares[addon].washer;
            }
        });

        // Apply deductions
        const totalCetadccoShare = cetadccoShare;
        const totalWasherShare = washerShare - 2 - vacDeduction; // 2 is for SSS

        if (cSharesInput) cSharesInput.value = totalCetadccoShare.toFixed(2);
        if (wShareInput) wShareInput.value = totalWasherShare.toFixed(2);
    }

    // Helper function to get addon price
    function getAddonPrice(addonName) {
        const selectedVehicle = vehicleTypeSelect.value;
        if (selectedVehicle && vehicleTypes[selectedVehicle] && vehicleTypes[selectedVehicle][addonName] !== undefined) {
            return vehicleTypes[selectedVehicle][addonName];
        }
        return 0;
    }

    // Add event listeners for form updates
    if (vehicleTypeSelect) {
        vehicleTypeSelect.addEventListener("change", () => {
            updatePrice();
            updateAddonServices();
        });
    }
    if (wVacCheckbox) wVacCheckbox.addEventListener("change", calculateShares);

    // Add event listeners for addon checkboxes
    addonCheckboxes.forEach(checkbox => {
        checkbox.addEventListener("change", updatePrice);
    });

    // Add event listeners for base service radio buttons
    const baseServiceRadios = document.querySelectorAll('input[name="base-service"]');
    baseServiceRadios.forEach(radio => {
        radio.addEventListener("change", () => {
            updateWVacSwitch();
            updatePrice();
            calculateShares();
        });
    });

    // Function to update w/vac switch based on selected base service
    function updateWVacSwitch() {
        const selectedBaseService = document.querySelector('input[name="base-service"]:checked');
        if (!selectedBaseService) return;

        const baseServiceName = selectedBaseService.value;
        const isVacuumService = baseServiceName === 'Bodywash with Vacuum' || baseServiceName === 'Vacuum Only';

        if (wVacCheckbox) {
            wVacCheckbox.checked = isVacuumService;
            wVacCheckbox.disabled = isVacuumService;

            // If it's not a vacuum service, enable the checkbox
            if (!isVacuumService) {
                wVacCheckbox.disabled = false;
            }
        }
    }

    // Modal
    btnOpen.onclick = () => {
        modal.style.display = "flex";
        // Center the modal content
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.margin = '0 auto';
        }
    };
    modalClose.onclick = () => modal.style.display = "none";

    // Temporary Button Modal
    if (btnTemporary) {
        btnTemporary.onclick = () => {
            temporaryModal.style.display = "flex";
            // Center the modal content
            const tempModalContent = temporaryModal.querySelector('.modal-content');
            if (tempModalContent) {
                tempModalContent.style.margin = '0 auto';
            }
            // Calculate and display values when modal opens
            calculateTemporaryFormValues();
        };
    }
    if (temporaryModalClose) {
        temporaryModalClose.onclick = () => temporaryModal.style.display = "none";
    }
    window.onclick = e => {
        if (e.target === modal) modal.style.display = "none";
        if (e.target === temporaryModal) temporaryModal.style.display = "none";
    };

    // Function to calculate values for the temporary form
    async function calculateTemporaryFormValues() {
        // Set wages to automatically be "400.00"
        const wagesInput = document.getElementById('wages');
        if (wagesInput) {
            wagesInput.value = "400.00";
        }
        // Get the current user's shift
        const userShiftElement = document.getElementById("user-shift");
        if (!userShiftElement) {
            console.error("User shift information not available");
            return;
        }

        const userShift = userShiftElement.textContent;
        const now = new Date();
        const manilaTzOffset = 8 * 60; // UTC+8 in minutes
        const manilaTime = new Date(now.getTime() + (manilaTzOffset - now.getTimezoneOffset()) * 60000);

        // Determine the current shift boundaries
        let shiftStart, shiftEnd;

        if (userShift === 'AM') {
            // AM shift: 5:00 AM - 5:00 PM
            shiftStart = new Date(manilaTime);
            shiftStart.setHours(5, 0, 0, 0);

            shiftEnd = new Date(manilaTime);
            shiftEnd.setHours(17, 0, 0, 0);
        } else {
            // PM shift: 5:00 PM - 5:00 AM next day
            if (manilaTime.getHours() >= 17) {
                // Current day PM shift
                shiftStart = new Date(manilaTime);
                shiftStart.setHours(17, 0, 0, 0);

                shiftEnd = new Date(manilaTime);
                shiftEnd.setDate(shiftEnd.getDate() + 1); // Next day
                shiftEnd.setHours(5, 0, 0, 0);
            } else {
                // Overnight PM shift (before 5:00 AM)
                shiftStart = new Date(manilaTime);
                shiftStart.setDate(shiftStart.getDate() - 1); // Previous day
                shiftStart.setHours(17, 0, 0, 0);

                shiftEnd = new Date(manilaTime);
                shiftEnd.setHours(5, 0, 0, 0);
            }
        }

        // Format dates for API
        const formatDate = (date) => date.toISOString().split('.')[0] + "Z";

        try {
            // Fetch orders for the current shift
            const response = await fetch(`/api/orders?date=${shiftStart.toISOString().split('T')[0]}&shift=${userShift}`);
            if (!response.ok) {
                console.error('Failed to fetch orders for calculation');
                return;
            }

            const orders = await response.json();

            // Filter orders within the shift time range
            const ordersInShift = orders.filter(order => {
                const orderTime = new Date(order.timestamp);
                return orderTime >= shiftStart && orderTime <= shiftEnd;
            });

            // Calculate Total Gross Sales with new logic
            let totalGrossSales = 0;

            // Load vehicle types first
            const vehicleTypesResponse = await fetch('/static/dict/vehicle_types.json');
            const vehicleTypesData = await vehicleTypesResponse.json();

            for (const order of ordersInShift) {
                // Get the price, vehicle name, and addons
                const price = parseFloat(order.price) || 0;
                const vehicleName = order.vehicle_name;
                const addons = order.addons ? order.addons.split(', ') : [];

                // Calculate the sum of addons prices with percentage adjustment
                let addonsTotal = 0;
                if (vehicleTypesData[vehicleName]) {
                    addons.forEach(addon => {
                        // Skip base services
                        if (['Bodywash', 'Bodywash with Vacuum', 'Vacuum Only', 'Spray Only'].includes(addon)) {
                            return;
                        }

                        const addonPrice = vehicleTypesData[vehicleName][addon];
                        if (addonPrice !== undefined && addonShares[addon]) {
                            // Apply the cetadcco share percentage to the addon price
                            addonsTotal += addonPrice; // * addonShares[addon].cetadcco;
                        }
                    });
                }

                // Subtract addons total from price
                const priceAfterAddons = price - addonsTotal;

                // Subtract 40 and multiply by 0.7
                const modifiedPrice = (priceAfterAddons - 40) * 0.7;

                // Add to total gross sales
                totalGrossSales += modifiedPrice;

                console.log(price);
                console.log(addonsTotal);
                console.log(modifiedPrice);
            }

            // Calculate 40x (40 * number of records)
            const fortyX = ordersInShift.length * 40;

            // Calculate addons sum with percentage adjustment
            const addonsSum = {};

            ordersInShift.forEach(order => {
                const vehicleName = order.vehicle_name;
                const addons = order.addons ? order.addons.split(', ') : [];

                if (vehicleTypes[vehicleName]) {
                    addons.forEach(addon => {
                        // Skip base services
                        if (['Bodywash', 'Bodywash with Vacuum', 'Vacuum Only', 'Spray Only'].includes(addon)) {
                            return;
                        }

                        const addonPrice = vehicleTypes[vehicleName][addon];
                        if (addonPrice !== undefined && addonShares[addon]) {
                            // Apply the cetadcco share percentage to the addon price
                            const adjustedPrice = addonPrice * addonShares[addon].cetadcco;
                            if (!addonsSum[addon]) {
                                addonsSum[addon] = 0;
                            }
                            addonsSum[addon] += adjustedPrice;
                        }
                    });
                }
            });

            console.log(totalGrossSales);
            console.log(addonsSum);
            console.log(fortyX);

            // Update the form fields
            document.getElementById('total-gross-sales').value = totalGrossSales.toFixed(2);
            document.getElementById('40x').value = fortyX.toFixed(2);

            // Update addons display
            const addonsContainer = document.getElementById('addons-container');
            if (addonsContainer) {
                addonsContainer.innerHTML = '';

                // Create a document fragment for better performance
                const fragment = document.createDocumentFragment();

                // Add each addon sum
                for (const [addonName, addonTotal] of Object.entries(addonsSum)) {
                    const div = document.createElement('div');
                    div.className = 'form-row';

                    const label = document.createElement('label');
                    label.textContent = addonName;
                    label.style.flex = '1';
                    label.style.minWidth = '120px';

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = addonTotal.toFixed(2);
                    input.readOnly = true;
                    input.style.flex = '1';
                    input.style.minWidth = '100px';

                    div.appendChild(label);
                    div.appendChild(input);
                    fragment.appendChild(div);
                }

                // Calculate total addons sum
                const totalAddons = Object.values(addonsSum).reduce((sum, value) => sum + value, 0);

                // Calculate and display total sales
                const totalSales = totalGrossSales + fortyX + totalAddons;

                // Add total sales
                const totalSalesDiv = document.createElement('div');
                totalSalesDiv.className = 'form-row';

                const totalSalesLabel = document.createElement('label');
                totalSalesLabel.style.fontWeight = 'bold';
                totalSalesLabel.textContent = `Total Sales: ₱${totalSales.toFixed(2)}`;
                totalSalesDiv.appendChild(totalSalesLabel);

                fragment.appendChild(totalSalesDiv);

                addonsContainer.appendChild(fragment);
            }

        } catch (error) {
            console.error("Error calculating temporary form values:", error);
        }
    }

    // Load orders & summary
    async function loadData() {
        const params = new URLSearchParams();
        // if (dateInput.value) params.set("date", dateInput.value);
        if (monthInput && monthInput.value) params.set("month", monthInput.value);

        // Check if the current shift is active
        const userShiftElement = document.getElementById("user-shift");
        const userRoleElement = document.querySelector(".user-role");

        // Debug log
        if (userRoleElement) {
            console.log("User role:", userRoleElement.textContent);
        } else {
            console.log("User role element not found");
        }

        // If user is admin or developer, always load data
        if (userRoleElement && (userRoleElement.textContent === 'Admin' || userRoleElement.textContent === 'Developer')) {
            try {
                // Fetch orders first
                const oRes = await fetch('/api/orders?' + params);
                if (!oRes.ok) {
                    console.error('Orders fetch failed:', oRes.status);
                    return;
                }
                const orders = await oRes.json();
                const rows = orders.map(o => ({ ...o, addons: typeof o.addons === 'object' ? JSON.stringify(o.addons) : o.addons || '' }));
                table.clearData();
                table.setData(rows);

                // Only load summary if user has permission (admin/dev)
                if (document.getElementById("sum-income")) {
                    const sRes = await fetch('/api/summary?' + params);
                    const summary = await sRes.json();

                    // document.getElementById("sum-income").textContent = `₱${summary.income.toFixed(2)}`;
                    // document.getElementById("sum-expenses").textContent = `₱${summary.expenses.toFixed(2)}`;
                    // document.getElementById("sum-cetadcco").textContent = `₱${summary.cetadcco_share.toFixed(2)}`;
                    // document.getElementById("sum-carwasher").textContent = `₱${summary.carwasher_share.toFixed(2)}`;

                    const net = summary.income
                        - summary.expenses
                        - summary.cetadcco_share
                        - summary.carwasher_share;
                    // document.getElementById("sum-net").textContent = `₱${net.toFixed(2)}`;
                }
            } catch (error) {
                console.error("Error loading data:", error);
            }
            return;
        }

        // For regular users, check shift status
        if (!userShiftElement) {
            console.error("User shift information not available");
            return;
        }

        const userShift = userShiftElement.textContent;
        const now = new Date();
        const currentHour = now.getHours();

        // Check if current time is within the user's shift
        let isWithinShift = false;
        if (userShift === 'AM') {
            isWithinShift = currentHour >= 5 && currentHour < 17;
        } else if (userShift === 'PM') {
            isWithinShift = currentHour >= 17 || currentHour < 5;
        }

        // Only load data if the shift is active
        if (!isWithinShift) {
            console.log("Current shift is inactive. Not loading orders.");
            return;
        }

        try {
            // Fetch orders first
            const oRes = await fetch('/api/orders?' + params);
            if (!oRes.ok) {
                console.error('Orders fetch failed:', oRes.status);
                return;
            }
            const orders = await oRes.json();
            const rows = orders.map(o => ({ ...o, addons: typeof o.addons === 'object' ? JSON.stringify(o.addons) : o.addons || '' }));
            table.clearData();
            table.setData(rows);

            // Only load summary if user has permission (admin/dev)
            if (document.getElementById("sum-income")) {
                const sRes = await fetch('/api/summary?' + params);
                const summary = await sRes.json();

                // document.getElementById("sum-income").textContent = `₱${summary.income.toFixed(2)}`;
                // document.getElementById("sum-expenses").textContent = `₱${summary.expenses.toFixed(2)}`;
                // document.getElementById("sum-cetadcco").textContent = `₱${summary.cetadcco_share.toFixed(2)}`;
                // document.getElementById("sum-carwasher").textContent = `₱${summary.carwasher_share.toFixed(2)}`;

                const net = summary.income
                    - summary.expenses
                    - summary.cetadcco_share
                    - summary.carwasher_share;
                // document.getElementById("sum-net").textContent = `₱${net.toFixed(2)}`;
            }
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    if (btnRefresh) btnRefresh.addEventListener("click", loadData);

    // Load previous shift data
    async function loadPreviousShiftData() {
        try {
            const response = await fetch('/api/previous-shift-orders');
            if (!response.ok) {
                console.error('Previous shift orders fetch failed:', response.status);
                return;
            }
            const orders = await response.json();
            const rows = orders.map(o => ({ ...o, addons: typeof o.addons === 'object' ? JSON.stringify(o.addons) : o.addons || '' }));
            table.clearData();
            table.setData(rows);
        } catch (error) {
            console.error("Error loading previous shift data:", error);
        }
    }

    // Submit new order
    if (form) {
        form.addEventListener("submit", async e => {
            e.preventDefault();

            // Get selected addons
            const selectedAddons = [];
            const addonCheckboxes = document.querySelectorAll('.addon-checkboxes input[type="checkbox"]');

            addonCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedAddons.push(checkbox.value);
                }
            });

            // Get selected base service
            const selectedBaseService = document.querySelector('input[name="base-service"]:checked');
            const baseService = selectedBaseService ? selectedBaseService.value : '';

            const vehicleName = vehicleTypeSelect ? vehicleTypeSelect.value : '';
            const combinedVehicleName = vehicleName;

            const payload = {
                vehicle_name: combinedVehicleName,
                plate_no: plateNoInput ? plateNoInput.value : '',
                w_vac: wVacCheckbox ? (wVacCheckbox.checked ? 'Yes' : 'No') : 'No',
                addons: selectedAddons.join(', '),
                base_service: baseService,
                price: parseFloat(priceInput ? priceInput.value : 0),
                c_shares: parseFloat(cSharesInput ? cSharesInput.value : 0),
                w_share: parseFloat(wShareInput ? wShareInput.value : 0),
                w_name: wNameInput ? wNameInput.value : ''
            };

            const r = await fetch("/api/orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (r.ok) {
                form.reset();
                modal.style.display = "none";
                loadData(); // Refresh the table data
                // Reset calculated fields and dropdowns
                if (cSharesInput) cSharesInput.value = '';
                if (wShareInput) wShareInput.value = '';
                if (serviceTypeSelect) {
                    serviceTypeSelect.innerHTML = '<option value="" disabled selected>Choose service</option>';
                }
                if (priceInput) priceInput.value = '';
            } else {
                const error = await r.json();
                alert("Failed to add order: " + (error.error || "Unknown error"));
            }
        });
    }

    // Shift timer functionality
    function updateShiftTimer() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinutes = now.getMinutes();

        // Get the current user's shift from the DOM
        const userShiftElement = document.getElementById("user-shift");
        if (!userShiftElement) {
            // If no shift info is available, don't show the timer
            const timerElement = document.getElementById("shift-timer");
            if (timerElement) timerElement.style.display = 'none';
            return;
        }

        const userShift = userShiftElement.textContent;
        const userRoleElement = document.querySelector(".user-role");

        // Check if current time is within the user's shift
        let isWithinShift = false;
        if (userShift === 'AM') {
            isWithinShift = currentHour >= 5 && currentHour < 17;
        } else if (userShift === 'PM') {
            isWithinShift = currentHour >= 17 || currentHour < 5;
        }

        // Special logic for InCharges - show temporary button 30 minutes before shift ends
        let showTemporaryButton = false;
        if (userRoleElement && userRoleElement.textContent === 'Incharge' && userShift === 'AM') {
            // For AM shift, show from 4:30 PM to 5:00 PM
            showTemporaryButton = (currentHour === 16 && currentMinutes >= 30) || (currentHour === 17 && currentMinutes === 0);
        } else if (userRoleElement && userRoleElement.textContent === 'Incharge' && userShift === 'PM') {

            showTemporaryButton = (currentHour === 4 && currentMinutes >= 30 || (currentHour === 5 && currentMinutes === 0));
        }

        // Show/hide elements based on shift and time
        const tableSection = document.querySelector('.table-section');
        const newOrderSection = document.querySelector('.new-order-section');
        const timerElement = document.getElementById("shift-timer");
        const previousShiftHeader = document.getElementById("previous-shift-header");
        const btnTemporary = document.getElementById("btn-temporary");
        const btnOpen = document.getElementById("btn-open-modal");

        if (timerElement) {
            if (isWithinShift) {
                // Show elements during user's shift
                if (tableSection) tableSection.style.display = 'block';
                if (newOrderSection) newOrderSection.style.display = 'block';
                timerElement.textContent = `Your shift: ${userShift} (Active)`;

                // Hide previous shift header for active shifts
                if (previousShiftHeader) previousShiftHeader.style.display = 'none';

                // Handle button visibility for InCharges
                if (userRoleElement && userRoleElement.textContent === 'Incharge') {
                    // Show temporary button 30 minutes before shift ends
                    if (showTemporaryButton) {
                        if (btnTemporary) btnTemporary.style.display = 'inline-block';
                    } else {
                        if (btnTemporary) btnTemporary.style.display = 'inline-block';
                    }

                    // Handle button visibility based on shift and time
                    if (userShift === 'AM') {
                        // Hide both buttons after 5:00 PM
                        if (currentHour >= 17) {
                            if (btnTemporary) btnTemporary.style.display = 'none';
                            if (btnOpen) btnOpen.style.display = 'none';
                        }
                        // Show btnOpen at 5:00 AM
                        else if (currentHour === 5) {
                            if (btnOpen) btnOpen.style.display = 'inline-block';
                            if (btnTemporary) btnTemporary.style.display = 'inline-block';
                        }
                        // Show btnTemporary at 4:30 PM
                        else if ((currentHour === 16 && currentMinutes >= 30) || (currentHour === 17 && currentMinutes === 0)) {
                            if (btnTemporary) btnTemporary.style.display = 'inline-block';
                            if (btnOpen) btnOpen.style.display = 'inline-block';
                        }
                    } else if (userShift === 'PM') {
                        // Hide both buttons after 5:00 AM
                        if (currentHour >= 5 && currentHour < 17) {
                            if (btnTemporary) btnTemporary.style.display = 'none';
                            if (btnOpen) btnOpen.style.display = 'none';
                        }
                        // Show btnOpen at 5:00 PM
                        else if (currentHour === 17) {
                            if (btnOpen) btnOpen.style.display = 'inline-block';
                            if (btnTemporary) btnTemporary.style.display = 'none';
                        }
                        // Show btnTemporary at 4:30 AM
                        else if ((currentHour === 4 && currentMinutes >= 30) || (currentHour === 5 && currentMinutes === 0)) {
                            if (btnTemporary) btnTemporary.style.display = 'inline-block';
                            if (btnOpen) btnOpen.style.display = 'none';
                        }
                    }
                }

                // Load current shift data
                if (tableEl) {
                    loadData();
                }
            } else {
                // Hide new order section but show table for previous shift
                if (newOrderSection) newOrderSection.style.display = 'none';
                if (tableSection) tableSection.style.display = 'block';
                timerElement.textContent = `Your shift: ${userShift} (Inactive - Outside shift hours)`;

                // Show previous shift header only for Incharges with inactive shifts
                if (previousShiftHeader && userRoleElement && userRoleElement.textContent === 'Incharge') {
                    previousShiftHeader.style.display = 'block';
                } else if (previousShiftHeader) {
                    previousShiftHeader.style.display = 'none';
                }

                // Load previous shift data
                if (tableEl) {
                    loadPreviousShiftData();
                }
            }
            timerElement.style.display = 'block';
        }
    }

    // Update timer every second
    setInterval(updateShiftTimer, 1000);
    updateShiftTimer(); // Initial call

    // Update current datetime every second
    function updateCurrentDatetime() {
        const now = new Date();
        const datetimeElement = document.getElementById("current-datetime");
        if (datetimeElement) {
            datetimeElement.textContent = `Current time: ${now.toLocaleString()}`;
        }
    }

    // Update current datetime every second
    setInterval(updateCurrentDatetime, 1000);
    updateCurrentDatetime(); // Initial call
    // Other Income functionality
    const addOtherIncomeBtn = document.getElementById('add-other-income');
    const otherIncomeDropdown = document.getElementById('other-income-dropdown');
    const otherIncomeContainer = document.createElement('div');
    otherIncomeContainer.id = 'other-income-container';
    otherIncomeContainer.className = 'form-row';

    // Insert the container after the dropdown
    if (otherIncomeDropdown) {
        otherIncomeDropdown.parentNode.insertBefore(otherIncomeContainer, otherIncomeDropdown.nextSibling);
    }

    if (addOtherIncomeBtn) {
        addOtherIncomeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            otherIncomeDropdown.style.display = otherIncomeDropdown.style.display === 'none' ? 'block' : 'none';
        });
    }

    // Handle dropdown item selection
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
            e.preventDefault();
            e.stopPropagation();
            const selectedValue = e.target.getAttribute('data-value');
            addOtherIncomeItem(selectedValue);
            otherIncomeDropdown.style.display = 'none';
        } else if (!addOtherIncomeBtn.contains(e.target) && !otherIncomeDropdown.contains(e.target)) {
            otherIncomeDropdown.style.display = 'none';
        }
    });

    function addOtherIncomeItem(name) {
        // Create a new row for the other income item
        const itemDiv = document.createElement('div');
        itemDiv.className = 'other-income-item';

        const label = document.createElement('label');
        label.textContent = name;

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.step = '0.01';
        input.placeholder = 'Amount';

        // Create delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn-secondary';
        deleteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            itemDiv.remove();
        });

        itemDiv.appendChild(label);
        itemDiv.appendChild(input);
        itemDiv.appendChild(deleteBtn);
        otherIncomeContainer.appendChild(itemDiv);
    }

    // Expenses functionality
    const addExpenseBtn = document.getElementById('add-expense');
    const expensesTable = document.getElementById('expenses-table').querySelector('tbody');

    if (addExpenseBtn) {
        addExpenseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addExpenseRow();
        });
    }

    function addExpenseRow() {
        const row = document.createElement('tr');

        // Name column
        const nameCell = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Name';
        nameCell.appendChild(nameInput);

        // Description column
        const descCell = document.createElement('td');
        const descInput = document.createElement('input');
        descInput.type = 'text';
        descInput.placeholder = 'Description';
        descCell.appendChild(descInput);

        // Amount column
        const amountCell = document.createElement('td');
        const amountInput = document.createElement('input');
        amountInput.type = 'number';
        amountInput.min = '0';
        amountInput.step = '0.01';
        amountInput.placeholder = 'Amount';
        amountCell.appendChild(amountInput);

        // Action column (delete button)
        const actionCell = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn-secondary';
        deleteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            row.remove();
        });
        actionCell.appendChild(deleteBtn);

        // Append all cells to the row
        row.appendChild(nameCell);
        row.appendChild(descCell);
        row.appendChild(amountCell);
        row.appendChild(actionCell);

        // Add the row to the table
        expensesTable.appendChild(row);
    }
    // Function to calculate and update the total for other income
    function updateOtherIncomeTotal() {
        const otherIncomeInputs = document.querySelectorAll('#other-income-container input[type="number"]');
        let total = 0;

        otherIncomeInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });

        // Display the total
        let otherIncomeTotalElement = document.getElementById('other-income-total');
        if (!otherIncomeTotalElement) {
            // Create the total display if it doesn't exist
            otherIncomeTotalElement = document.createElement('div');
            otherIncomeTotalElement.id = 'other-income-total';
            otherIncomeTotalElement.className = 'form-row';
            otherIncomeTotalElement.style.fontWeight = 'bold';
            otherIncomeTotalElement.style.marginTop = '10px';

            const otherIncomeContainer = document.getElementById('other-income-container');
            if (otherIncomeContainer) {
                otherIncomeContainer.appendChild(otherIncomeTotalElement);
            }
        }

        otherIncomeTotalElement.textContent = `Total: ₱${total.toFixed(2)}`;
    }

    // Add event listeners to other income inputs to update total when they change
    function addOtherIncomeEventListeners() {
        const otherIncomeContainer = document.getElementById('other-income-container');
        if (otherIncomeContainer) {
            otherIncomeContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    updateOtherIncomeTotal();
                }
            });
        }
    }

    // Call the function to set up event listeners
    addOtherIncomeEventListeners();

    // Function to calculate and update the total for expenses
    function updateExpensesTotal() {
        const expenseInputs = document.querySelectorAll('#expenses-table input[type="number"]');
        let total = 0;

        expenseInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });

        // Display the total
        let expensesTotalElement = document.getElementById('expenses-total');
        if (!expensesTotalElement) {
            // Create the total display if it doesn't exist
            expensesTotalElement = document.createElement('div');
            expensesTotalElement.id = 'expenses-total';
            expensesTotalElement.className = 'form-row';
            expensesTotalElement.style.fontWeight = 'bold';
            expensesTotalElement.style.marginTop = '10px';

            const expensesTable = document.getElementById('expenses-table');
            if (expensesTable) {
                expensesTable.parentNode.insertBefore(expensesTotalElement, expensesTable.nextSibling);
            }
        }

        expensesTotalElement.textContent = `Total Expenses: ₱${total.toFixed(2)}`;
    }

    // Add event listeners to expense inputs to update total when they change
    function addExpenseEventListeners() {
        const expensesTable = document.getElementById('expenses-table');
        if (expensesTable) {
            expensesTable.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    updateExpensesTotal();
                }
            });
        }
    }

    // Call the function to set up event listeners
    addExpenseEventListeners();

    // Function to calculate and update the grand total
    function updateGrandTotal() {
        // Get the total sales value
        const totalSalesElement = document.querySelector('#addons-container .form-row:last-child label');
        const totalSales = totalSalesElement ? parseFloat(totalSalesElement.textContent.replace('Total Sales: ₱', '')) || 0 : 0;

        // Get the total other income value
        const otherIncomeTotalElement = document.getElementById('other-income-total');
        const totalOtherIncome = otherIncomeTotalElement ? parseFloat(otherIncomeTotalElement.textContent.replace('Total: ₱', '')) || 0 : 0;

        // Get the total expenses value
        const expensesTotalElement = document.getElementById('expenses-total');
        const totalExpenses = expensesTotalElement ? parseFloat(expensesTotalElement.textContent.replace('Total Expenses: ₱', '')) || 0 : 0;

        // Calculate the grand total
        const grandTotal = totalSales + totalOtherIncome - totalExpenses;

        // Display the grand total
        const grandTotalElement = document.getElementById('grand-total');
        if (grandTotalElement) {
            grandTotalElement.textContent = `Total: ₱${grandTotal.toFixed(2)}`;
        }
    }

    // Add event listeners to update the grand total when any relevant value changes
    function addGrandTotalEventListeners() {
        // Listen for changes in the addons container (for total sales)
        const addonsContainer = document.getElementById('addons-container');
        if (addonsContainer) {
            addonsContainer.addEventListener('input', updateGrandTotal);
        }

        // Listen for changes in other income inputs
        const otherIncomeContainer = document.getElementById('other-income-container');
        if (otherIncomeContainer) {
            otherIncomeContainer.addEventListener('input', updateGrandTotal);
        }

        // Listen for changes in expense inputs
        const expensesTable = document.getElementById('expenses-table');
        if (expensesTable) {
            expensesTable.addEventListener('input', updateGrandTotal);
        }
    }

    // Call the function to set up event listeners
    addGrandTotalEventListeners();
});    // Temporary form submission handler
    const temporaryModalSubmit = document.getElementById('temporary-modal-submit');
    if (temporaryModalSubmit) {
        temporaryModalSubmit.addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                // Collect all form data
                const formData = {
                    // Total sales from first column
                    total_gross_sales: parseFloat(document.getElementById('total-gross-sales')?.value) || 0,
                    forty_x: parseFloat(document.getElementById('40x')?.value) || 0,
                    
                    // Addons from first column
                    addons: {},
                    
                    // Other income from second column
                    other_income: {},
                    
                    // Expenses from second column
                    expenses: {},
                    
                    // Additional fields
                    wages: parseFloat(document.getElementById('wages')?.value) || 0,
                    gcash: parseFloat(document.getElementById('gcash')?.value) || 0,
                    grand_total: 0 // Will be calculated
                };
                
                // Collect addon data
                const addonInputs = document.querySelectorAll('#addons-container input[type="number"]');
                addonInputs.forEach(input => {
                    const label = input.parentElement.querySelector('label');
                    if (label && input.value) {
                        const addonName = label.textContent.trim();
                        formData.addons[addonName] = parseFloat(input.value);
                    }
                });
                
                // Collect other income data
                const otherIncomeInputs = document.querySelectorAll('#other-income-container input[type="number"]');
                otherIncomeInputs.forEach(input => {
                    const label = input.parentElement.querySelector('label');
                    if (label && input.value) {
                        const incomeName = label.textContent.trim();
                        formData.other_income[incomeName] = parseFloat(input.value);
                    }
                });
                
                // Collect expenses data
                const expenseRows = document.querySelectorAll('#expenses-table tbody tr');
                expenseRows.forEach(row => {
                    const nameInput = row.querySelector('input[placeholder="Name"]');
                    const descInput = row.querySelector('input[placeholder="Description"]');
                    const amountInput = row.querySelector('input[placeholder="Amount"]');
                    
                    if (nameInput && nameInput.value && amountInput && amountInput.value) {
                        formData.expenses[nameInput.value] = {
                            description: descInput?.value || '',
                            amount: parseFloat(amountInput.value)
                        };
                    }
                });
                
                // Calculate grand total
                const totalSales = formData.total_gross_sales + formData.forty_x + Object.values(formData.addons).reduce((sum, val) => sum + val, 0);
                const totalOtherIncome = Object.values(formData.other_income).reduce((sum, val) => sum + val, 0);
                const totalExpenses = Object.values(formData.expenses).reduce((sum, expense) => sum + expense.amount, 0);
                formData.grand_total = totalSales + totalOtherIncome - totalExpenses;
                
                // Send data to API
                const response = await fetch('/api/shift-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Shift summary submitted successfully!\\nDate: ${result.date}\\nShift: ${result.shift}`);
                    
                    // Close the modal
                    temporaryModal.style.display = 'none';
                    
                    // Optionally refresh the page or clear the form
                    // location.reload();
                } else {
                    const error = await response.json();
                    alert(`Failed to submit shift summary: ${error.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Error submitting shift summary:', error);
                alert('An error occurred while submitting the shift summary. Please try again.');
            }
        });
    }
